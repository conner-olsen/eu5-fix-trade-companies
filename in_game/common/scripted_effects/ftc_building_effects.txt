# Adds the sum of constructing temp buildings and constructed permanent buildings to the location
# as a variable named $building_type$_max_queue
# ROOT: building
# ARGS: building_type
ftc_set_max_queue = {
	owner = {
		save_temporary_scope_as = builder_scope
	}
	location = {
		# set value equal to existing construction +1 as numbering starts at 0
		set_variable = {
			name = $building_type$_max_queue
			value = prev.building_levels_under_construction
		}
		# add the number of existing levels to the variable
		every_buildings_in_location = {
			limit = {
				building_type = building_type:$building_type$
				OR = {
					owner = scope:builder_scope
					owner = {
						is_subject_of = root.owner
					}
				}
			}
			prev = {
				change_variable = {
					name = $building_type$_max_queue
					add = prev.building_level
				}
			}
		}
	}
}

# save the level that the building should be if the construction completes
# we use this to keep track of if the construction was completed or cancaled when `on_construction_ended`
# is called
# ROOT: building
# ARGS: building_type
ftc_set_target_level = {
	owner = {
		save_temporary_scope_as = owner_scope
	}
	location = {
		every_buildings_in_location = {
			limit = {
				building_type = building_type:$building_type$
				OR = {
					owner = scope:owner_scope
					owner = {
						is_subject_of = scope:owner_scope
					}
				}
			}
			location = {
				set_variable = {
					name = $building_type$_target_level
					value = prev.building_level
				}
			}
		}
		if = {
			limit = {
				NOT = {
					has_variable = $building_type$_target_level
				}
			}
			set_variable = {
				name = $building_type$_target_level
				value = 0
			}
		}
	}
}

# Called whenever a temp_construction is started
# build the max queue and determine the target level when a temp
# ROOT: building
# ARGS: building_type
ftc_temp_on_construction_started = {
	ftc_set_max_queue = {
		building_type = $building_type$
	}
	ftc_set_target_level = {
		building_type = $building_type$
	}
}

# either construct a new building or add a level to an existing building in a location
# ROOT: location
# ARGS: building_type; builder
ftc_add_level_to_location = {
	every_buildings_in_location = {
		limit = {
			building_type = building_type:$building_type$
			OR = {
				owner = $builder$
				owner = {
					is_subject_of = $builder$
				}
			}
			is_max_level = no
		}
		save_temporary_scope_as = building_to_level
	}
	if = {
		limit = {
			exists = scope:building_to_level
		}
		scope:building_to_level = {
			change_building_level = 1
		}
	}
	else = {
		construct_building = {
			building_type = building_type:$building_type$
			cost_multiplier = 0
			instant = yes
			cost_multiplier_reason = "game_concept_foreign_building"
			owner = $builder$
		}
	}
}

# update construction queue in a location
# ROOT: building that finished construction
# ARGS: building_type
ftc_temp_construction_complete = {
	owner = {
		save_temporary_scope_as = owner_scope
	}
	location = {
		ftc_add_level_to_location = {
			building_type = $building_type$
			builder = scope:owner_scope
		}
	}
	ftc_set_target_level = {
		building_type = $building_type$
	}
}

# Use the target level to check if the construction was completed or canceled and route accordingly
# ROOT: building
# ARGS: building_type
ftc_temp_on_construction_ended = {
	if = {
		limit = {
			root.building_level = location.var:$building_type$_target_level
		}
		ftc_temp_construction_complete = {
			building_type = $building_type$
		}
	}
	else = {
		location = {
			set_variable = construction_canceled
		}
	}
	location = {
		if = {
			limit = {
				var:$building_type$_max_queue = 0
			}
			remove_variable = $building_type$_max_queue
			remove_variable = $building_type$_target_level
		}
	}
	# if there are no more temp levels under construction, destroy the temp building and clear vars
	if = {
		limit = {
			building_levels_under_construction = 0
		}
		trigger_event_non_silently = {
			on_action = ftc_cleanup_temp_buildings_on_action
			days = 1
		}
		remove_variable = $building_type$_max_queue
		remove_variable = $building_type$_target_level
	}
}

# start construction of perm; used only foreign buildings with a max_level of 1
# this includes: embassy, missonary_building, overseas_trading_post, slave_center 
ftc_temp_on_built = {
}

# For some reason doesn't work when done in the same operation as deleting the temp building.
# Thus why the on_construction_started.
ftc_perm_on_construction_started = {
	location = {
		# destroy temp pop
		every_pop = {
			limit = {
				pop_type = pop_type:temp
			}
			destroy_pop = this
		}
	}
}

# Trasnfer the ownership of a building to a TC subject in a region, if one exists
# ROOT: building
ftc_transfer_ownership = {
	location.region = {
		save_temporary_scope_as = building_region
	}
	owner = {
		every_subject = {
			limit = {
				has_variable = trade_company_home_region
				var:trade_company_home_region = scope:building_region
			}
			save_temporary_scope_as = new_owner
		}
	}
	if = {
		limit = {
			exists = scope:new_owner
		}
		change_building_owner = scope:new_owner
	}
}

# Deletes the temporary building and all temp pops in the location
# Must be called by the delayed on_action to prevent deleting the active scope.
# ROOT: building
ftc_cleanup_temp_buildings = {
	# ROOT here = building, PREV = country
	location = {
		# In this block ROOT = location, PREV = building
		# So this destroys the building its called on.
		destroy_building = prev
		# destroy temp pop
		every_pop = {
			limit = {
				pop_type = pop_type:temp
			}
			destroy_pop = this
		}
	}
}

# Sets the target level for further constructions, and transfers ownership to appropriate
# subject if present
# ROOT: building
# ARGS: building_type
ftc_perm_on_built = {
	ftc_set_target_level = {
		building_type = $building_type$
	}
	ftc_transfer_ownership
}
