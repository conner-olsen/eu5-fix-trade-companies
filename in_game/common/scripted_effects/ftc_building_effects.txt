# Determine how many levels a building type in a location should get, and level it up appropriately
# ROOT: location
# ARGS: building_type
ftc_level_up = {
	# check for existing levels
	every_buildings_in_location = {
		limit = {
			building_type = building_type:$building_type$
			owner = {
				is_subject_of = root.owner
			}
			is_max_level = no
		}
		save_temporary_scope_as = building_to_replace
	}
	region = {
		save_temporary_scope_as = building_region
	}
	# if there are existing levels, add them to the new building with the queue size
	if = {
		limit = {
			exists = scope:building_to_replace
		}
		set_local_variable = {
			name = level_change
			value = scope:building_to_replace.building_level
		}
		change_local_variable = {
			name = level_change
			add = var:$building_type$_queue_size
		}
		# subtract one to offset queue_size, and one to offset existing levels
		change_local_variable = {
			name = level_change
			subtract = 2
		}
		# destroy old building
		destroy_building = scope:building_to_replace
	}
	# Otherwise use queue size, subtract 1 from the queue size since 1 level will go down it's own
	else = {
		set_local_variable = {
			name = level_change
			value = var:$building_type$_queue_size
		}
		change_local_variable = {
			name = level_change
			subtract = 1
		}
	}
	prev = {
		change_building_level = local_var:level_change
	}
}

# Trasnfer the ownership of a building to a TC subject in a region, if one exists
# ROOT: building
ftc_transfer_ownership = {
	owner = {
		every_subject = {
			limit = {
				has_variable = trade_company_home_region
				var:trade_company_home_region = scope:building_region
			}
			save_temporary_scope_as = new_owner
		}
	}
	change_building_owner = scope:new_owner
}

# Adds the sum of constructing temp buildings and constructed permanent buildings to the location
# as a variable named $building_type$_queue_size
# ROOT: building
# ARGS: 
# building_type
# existing_levels - value: number of existing temp buildings queued
ftc_count_queue = {
	location = {
		# set value equal to existing construction +1 as numbering starts at 0
		set_variable = {
			name = $building_type$_queue_size
			value = prev.building_levels_under_construction
		}
		change_variable = {
			name = $building_type$_queue_size
			add = 1
		}
		# add the number of existing levels to the variable
		every_buildings_in_location = {
			limit = {
				building_type = building_type:$building_type$
				owner = {
					is_subject_of = root.owner
				}
			}
			prev = {
				change_variable = {
					name = $building_type$_queue_size
					add = prev.building_level
				}
			}
		}
	}
}

# Constructs the permanent version of a building after the temporary one is built
# ROOT: building
# ARGS: building_type
ftc_built_temp = {
	owner = {
		save_temporary_scope_as = owner_scope
	}
	location = {
		construct_building = {
			building_type = building_type:$building_type$
			cost_multiplier = 0
			instant = yes
			cost_multiplier_reason = "game_concept_foreign_building"
			owner = scope:owner_scope
		}
	}
	trigger_event_non_silently = {
		on_action = ftc_cleanup_temp_buildings_on_action
		days = 1
	}
}

# Checks to see if the location has any existing levels
# If it does, we had those levels to the perm and destroy the old one
# If it doesn not, we simply transfer owner ship of this building
# ROOT: building
# ARGS: building_type
ftc_built_perm = {
	location = {
		# destroy temp building
		destroy_all_buildings_of_type = building_type:$building_type$_temp
		ftc_level_up = {
			building_type = $building_type$
		}
		remove_variable = $building_type$_queue_size
	}
	ftc_transfer_ownership
}

# Deletes the temporary building and all temp pops in the location
# Must be called by the delayed on_action to prevent deleting the active scope.
# ROOT: building
ftc_cleanup_temp_buildings = {
	# ROOT here = building, PREV = country
	location = {
		# In this block ROOT = location, PREV = building
		# So this destroys the building its called on.
		destroy_building = prev
	}
}

# For some reason doesn't work when done in the same operation as deleting the temp building.
# Thus why the on_construction_started.
ftc_permanent_building_construction_started = {
	location = {
		# destroy temp pop
		every_pop = {
			limit = {
				pop_type = pop_type:temp
			}
			destroy_pop = this
		}
	}
}
