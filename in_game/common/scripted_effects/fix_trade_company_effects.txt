# Transfers the ownership of all foreign buildings in a location to the trade company if one 
#  exists in the region
# owner_scope: scope of the country that built the building: ex. scope:owner_scope
# location_scope: scope of the location where the building was constructed: ex. scope:location_scope
tcf_transfer_foreign_buildings = {
	$owner_scope$ = {
		every_subject = {
			limit = {
				has_variable = trade_company_home_region
				var:trade_company_home_region = $location_scope$.region
			}
			save_temporary_scope_as = trade_company
			$location_scope$ = {
				every_buildings_in_location = {
					limit = { owner = $owner_scope$ }
					change_building_owner = scope:trade_company
				}
			}
		}
	}
}

# Constructs the permanent version of a building after the temporary one is built
# call from building scope
# building_type: the building type of the temporary building constructed: ex. trade_office
tcf_built_temp = {
	owner = { save_temporary_scope_as = owner_scope }
	location = {
		construct_building = {
			building_type = building_type:$building_type$
			instant = yes
			cost_multiplier = 0
			cost_multiplier_reason = "game_concept_foreign_building"
			owner = scope:owner_scope
		}
	}
}

# Destroys the temporary building and pops, then transfers foreign buildings to the trade company
# call from building scope
# building_type: the building type of the temporary building constructed: ex. trade_office
tcf_built_permanent = {
	location = {
		save_temporary_scope_as = location_scope
		destroy_all_buildings_of_type = building_type:$building_type$_temp
		every_pop = {
			limit = {
				pop_type = pop_type:temp
			}
			destroy_pop = this
		}
	}
	owner = { save_temporary_scope_as = owner_scope }
	tcf_transfer_foreign_buildings = {
		owner_scope = scope:owner_scope
		location_scope = scope:location_scope
	}

}

# If there isn't a building in the province already, constructs the permanent version of a trade 
# company building after the temporary one is built and transfers ownership to the appropriate trade 
# company country. If the building already exists, increase the level of the building
# call from building scope
# building_type: the building type of the temporary building constructed: ex. trade_company_harbor
tcf_built_permanent_tc = {
	owner = { save_temporary_scope_as = overlord_scope }
	
	# if the building type exists, is owned by one of our subjects, and is not at max level;
	# increase the level by 1 and destroy the building just built 
	if = {
		limit = {
			location = {
				any_buildings_in_location = {
					building_type = building_type:$building_type$ 
					owner = { is_subject_of = scope:overlord_scope }
					is_max_level = no
				}
			}
		}
		location = {
			# level up TC owned building
			every_buildings_in_location = {
				limit = {
					building_type = building_type:$building_type$
					owner = { is_subject_of = scope:overlord_scope }
					is_max_level = no
				}
				change_building_level = 1
			}
			# destroy temp pops
			every_pop = {
				limit = { pop_type = pop_type:temp }
				destroy_pop = this
			}
			# Destroy temp buildings
			destroy_all_buildings_of_type = building_type:$building_type$_temp	
			# Destroy overlord owned permanent building
			every_buildings_in_location = {
				limit = {
					building_type = building_type:$building_type$
					owner = scope:overlord_scope
				}
				save_temporary_scope_as = old_building
			}
			scope:overlord_scope = {
				add_to_variable_list = {
					name = destroy_these
					target = scope:old_building
				}
			}
		}
	}
	else = {
		tcf_built_permanent = { building_type = $building_type$ }
		owner = {
			if = {
				limit = { NOT = { has_variable = trade_company_home_region } }
				save_temporary_scope_as = owner_scope
				random_in_list = {
					variable = trade_company_subjects
					limit = {
						has_variable = trade_company_home_region
						var:trade_company_home_region = {
							save_temporary_scope_as = target_region
						}
						scope:owner_scope = {
							is_target_in_variable_list = {
								name = trade_company_regions
								target = scope:target_region
							}
						}
					}
					save_scope_as = trade_company_country
				}
				if = {
					limit = { exists = scope:trade_company_country }
					root = { change_building_owner = scope:trade_company_country }
				}
			}
		}
	}
}